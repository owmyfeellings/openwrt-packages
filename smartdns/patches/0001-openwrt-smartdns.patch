From 1acef15b97889a7fbf795d26df390dc2b06d67bd Mon Sep 17 00:00:00 2001
From: jinsh <jinsh11@chinatelecom.cn>
Date: Wed, 25 Aug 2021 18:00:50 +0800
Subject: [PATCH] =?UTF-8?q?=E8=A7=A3=E5=86=B3openwrt=E7=8E=AF=E5=A2=83?=
 =?UTF-8?q?=E5=81=9C=E6=AD=A2smartdns=E6=9C=8D=E5=8A=A1=E5=90=8E=EF=BC=8C?=
 =?UTF-8?q?=E9=85=8D=E7=BD=AE=E5=AD=98=E5=9C=A8=E6=AE=8B=E7=95=99=E9=97=AE?=
 =?UTF-8?q?=E9=A2=98?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 package/openwrt/files/etc/init.d/smartdns | 25 +++++++++++++++++++++++
 1 file changed, 25 insertions(+)

diff --git a/package/openwrt/files/etc/init.d/smartdns b/package/openwrt/files/etc/init.d/smartdns
index 2bf799e..a502ca1 100644
--- a/package/openwrt/files/etc/init.d/smartdns
+++ b/package/openwrt/files/etc/init.d/smartdns
@@ -32,6 +32,8 @@ SMARTDNS_CONF_TMP="${SMARTDNS_CONF}.tmp"
 COREDUMP="0"
 RESPAWN="1"
 
+DEBUG="logger -t smartdns -p debug "
+
 set_forward_dnsmasq()
 {
 	local PORT="$1"
@@ -388,3 +390,26 @@ reload_service()
 	stop
 	start
 }
+
+stop_smartdns()
+{
+    local section="$1"
+	config_get port "$section" "port" "6053"
+	config_get redirect "$section" "redirect" "none"
+	config_get ipv6_server "$section" "ipv6_server" "1"
+	
+	$DEBUG  "stop smartdns port:$port, redirect:$redirect,ipv6_server:$ipv6_server."
+	if [ "$redirect" = "redirect" ]; then
+		clear_iptable $port $ipv6_server
+	elif [ "$redirect" = "dnsmasq-upstream" ]; then
+		stop_forward_dnsmasq "$port"
+    fi
+}
+
+stop_service()
+{
+	config_load "smartdns"
+	config_foreach stop_smartdns "smartdns"
+    killall -s SIGTERM smartdns
+       
+}
-- 
2.34.1

